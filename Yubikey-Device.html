<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restrict YubiKey Usage</title>
</head>
<body>
    <h1>Restrict YubiKey Usage at the OS Level Using Intune and Certificate-Based Authentication</h1>
    
    <h2>Overview of the Process</h2>
    <ul>
        <li>Set Up Intune for Device Management</li>
        <li>Enable Windows Hello for Business (WHfB) with Certificate-Based Authentication</li>
        <li>Configure an Enterprise PKI for Certificate Issuance</li>
        <li>Enroll YubiKey in PIV Mode and Issue a User Certificate</li>
        <li>Bind the YubiKey to a Specific Device Using Intune & Conditional Access</li>
        <li>Test Authentication & Restriction Enforcement</li>
    </ul>
    
    <h2>1. Set Up Intune for Device Management</h2>
    <h3>Step 1: Enroll Devices in Intune</h3>
    <ol>
        <li>Go to the <a href="https://intune.microsoft.com">Microsoft Intune Admin Center</a></li>
        <li>Navigate to <strong>Devices > Windows > Enrollment</strong></li>
        <li>Ensure the device enrollment method (Autopilot or manually) is enabled.</li>
        <li>Assign a device compliance policy requiring <strong>device compliance for authentication</strong>.</li>
    </ol>
    
    <h2>2. Enable Windows Hello for Business with Certificate-Based Authentication</h2>
    <h3>Step 1: Enable CBA in Azure AD</h3>
    <ol>
        <li>Go to <a href="https://aad.portal.azure.com">Azure AD Admin Center</a></li>
        <li>Navigate to <strong>Azure Active Directory > Security > Authentication Methods</strong>.</li>
        <li>Under <strong>Certificate-Based Authentication</strong>, select <strong>Enable</strong>.</li>
        <li>Define authentication rules for CBA:</li>
        <ul>
            <li>User Binding: Use <strong>UPN</strong> or <strong>email address</strong>.</li>
            <li>Certificate Issuance Policy: Choose <strong>Issuer DN</strong> of your CA.</li>
            <li>Revocation Check: Enable <strong>OCSP</strong> or <strong>CRL</strong>.</li>
        </ul>
    </ol>
    
    <h3>Step 2: Configure Intune Policy to Require Smart Card</h3>
    <ol>
        <li>Go to <strong>Intune Admin Center</strong>.</li>
        <li>Navigate to <strong>Endpoint Security > Account Protection > Windows Hello for Business</strong>.</li>
        <li>Click <strong>Create Policy</strong> and set:</li>
        <ul>
            <li>Enable Windows Hello for Business: <strong>Yes</strong>.</li>
            <li>Key Trust or Certificate Trust: <strong>Choose Certificate Trust</strong>.</li>
            <li>Require Hardware-Backed TPM: <strong>Yes</strong>.</li>
            <li>Allow Certificate Authentication Only: <strong>Yes</strong>.</li>
        </ul>
    </ol>
    
    <h2>3. Configure Enterprise PKI for Certificate Issuance</h2>
    <h3>Step 1: Set Up an Enterprise CA</h3>
    <pre>
    Install-WindowsFeature ADCS-Cert-Authority -IncludeManagementTools
    Install-AdcsCertificationAuthority -CAType EnterpriseRootCA
    </pre>
    
    <h3>Step 2: Create a Certificate Template for YubiKey (PIV)</h3>
    <ol>
        <li>Open <strong>Certification Authority</strong> (certsrv.msc).</li>
        <li>Duplicate the <strong>Smart Card Logon</strong> template.</li>
        <li>Set <strong>Subject Name</strong> to <strong>User Principal Name (UPN)</strong>.</li>
        <li>Enable <strong>Client Authentication & Smart Card Logon</strong>.</li>
    </ol>
    
    <h2>4. Enroll YubiKey in PIV Mode and Issue a User Certificate</h2>
    <h3>Step 1: Configure YubiKey for PIV Mode</h3>
    <ol>
        <li>Download and install <a href="https://www.yubico.com/products/services-software/download/yubikey-manager/">YubiKey Manager</a>.</li>
        <li>Navigate to <strong>Applications > PIV</strong>.</li>
        <li>Generate a <strong>Certificate Signing Request (CSR)</strong>.</li>
    </ol>
    
    <h2>5. Bind the YubiKey to a Specific Device Using Intune & Conditional Access</h2>
    <h3>Step 1: Create a Conditional Access Policy</h3>
    <ol>
        <li>Go to <strong>Azure AD Admin Center</strong>.</li>
        <li>Navigate to <strong>Security > Conditional Access</strong>.</li>
        <li>Click <strong>Create Policy</strong> and configure required settings.</li>
    </ol>
    
    <h2>6. Test Authentication & Restriction Enforcement</h2>
    <p>Try logging into a non-enrolled device using the <strong>YubiKey</strong>. Authentication should <strong>fail</strong>. On an enrolled device, authentication should <strong>succeed</strong>.</p>
    
    </body>
</html>
